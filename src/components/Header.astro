---
import { navLinks } from '@/data/navigation';
import { Image } from 'astro:assets';
import ogImage from '@/assets/images/og-image.png';
---

<header
  class="w-full border-b border-border-primary sticky top-0 z-[60] bg-bg-primary/95 backdrop-blur-sm"
>
  <!-- Skip to main content link for accessibility -->
  <a
    href="#main-content"
    class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-[60] focus:px-4 focus:py-2 focus:bg-accent focus:text-black focus:rounded-lg focus:font-semibold"
  >
    Skip to main content
  </a>
  <div class="mx-auto max-w-7xl h-16 md:h-20 px-6 flex items-center justify-between">
    <!-- Logo with monogram -->
    <a href="/" class="flex items-center gap-3 group">
      <Image src={ogImage} alt="DevCult" class="header-logo-image" loading="eager" />
      <span class="font-semibold font-coconat text-xl"> DevCult </span>
    </a>

    <nav class="hidden md:flex items-center gap-6">
      {
        navLinks.map((link) => (
          <a href={link.href} class="text-text-secondary hover:text-accent transition-colors">
            {link.label}
          </a>
        ))
      }
    </nav>

    <!-- Mobile menu toggle buttons -->
    <button
      id="mobile-menu-btn"
      class="md:hidden p-2"
      aria-label="Open menu"
      aria-expanded="false"
      aria-controls="mobile-menu"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M4 6h16M4 12h16M4 18h16"></path>
      </svg>
    </button>

    <button id="mobile-menu-close" class="hidden md:hidden p-2" aria-label="Close menu">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  </div>
</header>

<!-- Mobile menu -->
<div
  id="mobile-menu"
  class="hidden md:hidden fixed top-16 left-0 right-0 bottom-0 z-50 bg-bg-primary/98 backdrop-blur-sm"
  role="dialog"
  aria-modal="true"
  aria-label="Mobile navigation"
>
  <nav class="flex flex-col items-center gap-8 pt-12">
    {
      navLinks.map((link) => (
        <a href={link.href} class="text-2xl hover:text-accent transition-colors">
          {link.label}
        </a>
      ))
    }
  </nav>
</div>

<script>
  const btn = document.getElementById('mobile-menu-btn');
  const menu = document.getElementById('mobile-menu');
  const close = document.getElementById('mobile-menu-close');

  // Focusable elements for focus trap
  let focusableElements: HTMLElement[] = [];
  let firstFocusableElement: HTMLElement | null = null;
  let lastFocusableElement: HTMLElement | null = null;
  let scrollPosition = 0;

  // Prevent touch scroll on body when menu is open
  function preventScroll(e: TouchEvent) {
    e.preventDefault();
  }

  function openMenu() {
    menu?.classList.remove('hidden');
    btn?.setAttribute('aria-expanded', 'true');
    btn?.classList.add('hidden');
    close?.classList.remove('hidden');

    // Lock body scroll - save position and apply fixed positioning
    scrollPosition = window.scrollY;
    document.body.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollPosition}px`;
    document.body.style.width = '100%';

    // Prevent touch scrolling on mobile
    document.addEventListener('touchmove', preventScroll, { passive: false });

    // Setup focus trap - include close button and menu items
    const menuLinks = Array.from(menu?.querySelectorAll<HTMLElement>('a[href]') || []);
    focusableElements = close ? [close, ...menuLinks] : menuLinks;
    firstFocusableElement = focusableElements[0] || null;
    lastFocusableElement = focusableElements[focusableElements.length - 1] || null;

    // Focus close button
    close?.focus();
  }

  function closeMenu() {
    menu?.classList.add('hidden');
    btn?.setAttribute('aria-expanded', 'false');
    btn?.classList.remove('hidden');
    close?.classList.add('hidden');

    // Unlock body scroll - restore position
    document.body.style.overflow = '';
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.width = '';
    window.scrollTo(0, scrollPosition);

    // Remove touch scroll prevention
    document.removeEventListener('touchmove', preventScroll);

    // Return focus to menu button
    btn?.focus();
  }

  // Handle focus trap
  function handleFocusTrap(e: KeyboardEvent) {
    if (menu?.classList.contains('hidden')) return;

    if (e.key === 'Tab') {
      if (e.shiftKey) {
        // Shift+Tab: if on first element, go to last
        if (document.activeElement === firstFocusableElement) {
          e.preventDefault();
          lastFocusableElement?.focus();
        }
      } else {
        // Tab: if on last element, go to first
        if (document.activeElement === lastFocusableElement) {
          e.preventDefault();
          firstFocusableElement?.focus();
        }
      }
    }
  }

  // Handle escape key
  function handleEscape(e: KeyboardEvent) {
    if (e.key === 'Escape' && !menu?.classList.contains('hidden')) {
      closeMenu();
    }
  }

  btn?.addEventListener('click', openMenu);
  close?.addEventListener('click', closeMenu);
  menu?.querySelectorAll('a').forEach((a) => a.addEventListener('click', closeMenu));
  document.addEventListener('keydown', handleEscape);
  document.addEventListener('keydown', handleFocusTrap);
</script>

<style>
  .header-logo-image {
    width: 32px;
    height: auto;
    object-fit: contain;
    background: transparent;
    transition: transform 0.2s ease;
  }

  .group:hover .header-logo-image {
    transform: scale(1.1);
  }

  @media (min-width: 768px) {
    .header-logo-image {
      width: 40px;
    }
  }
</style>
