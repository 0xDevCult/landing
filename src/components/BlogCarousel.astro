---
import { XMLParser } from 'fast-xml-parser';

interface BlogPost {
  title: string;
  url: string;
  excerpt: string;
  pubDate: string;
}

interface RSSItem {
  title?: string;
  link?: string;
  description?: string;
  pubDate?: string;
}

let posts: BlogPost[] = [];

try {
  // Fetch with 5 second timeout
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 5000);

  const response = await fetch('https://blog.devcult.io/rss.xml', {
    signal: controller.signal,
  });

  clearTimeout(timeoutId);

  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }

  const xml = await response.text();

  // Parse XML safely
  const parser = new XMLParser({
    ignoreAttributes: false,
    parseTagValue: false,
    trimValues: true,
  });

  const parsed = parser.parse(xml);
  const items = parsed?.rss?.channel?.item || [];

  // Normalize to array if single item
  const itemsArray = Array.isArray(items) ? items : [items];

  posts = itemsArray.slice(0, 6).map((item: RSSItem) => {
    const title = item.title || '';
    const url = item.link || '';
    // Strip HTML tags from description and truncate
    const rawExcerpt = item.description || '';
    const plainExcerpt = rawExcerpt.replace(/<[^>]*>/g, '').trim();
    const excerpt = plainExcerpt.length > 150 ? plainExcerpt.slice(0, 150) + '...' : plainExcerpt;
    const pubDate = item.pubDate || '';

    return { title, url, excerpt, pubDate };
  });
} catch (e) {
  if (e instanceof Error) {
    if (e.name === 'AbortError') {
      console.error('Blog RSS fetch timed out after 5 seconds');
    } else {
      console.error('Failed to fetch blog posts:', e.message);
    }
  } else {
    console.error('Failed to fetch blog posts:', e);
  }
}
---

<section class="py-24 bg-bg-secondary">
  <div class="mx-auto max-w-7xl px-6">
    <h2 data-animate class="text-3xl md:text-4xl font-bold font-coconat text-center">
      Latest from the Blog
    </h2>

    {
      posts.length > 0 ? (
        <div class="mt-12">
          <div class="flex flex-col md:grid md:grid-cols-3 gap-6">
            {posts.slice(0, 3).map((post, i) => (
              <a
                href={post.url}
                data-animate
                data-delay={100 + i * 100}
                class="p-6 rounded-xl bg-brand-alpha-5 border-l-4 border-l-brand-500 border-t border-t-brand-500 border-r border-r-brand-500 border-b border-b-brand-500 hover:border-l-brand-400 transition-all group"
              >
                <p class="text-xs text-text-primary">
                  {new Date(post.pubDate).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                  })}
                </p>
                <h3 class="mt-2 text-lg font-semibold font-coconat line-clamp-2 text-text-primary group-hover:text-accent transition-colors">
                  {post.title}
                </h3>
                <p class="mt-2 text-sm line-clamp-2 text-text-primary">{post.excerpt}</p>
                <span class="mt-4 inline-block text-sm text-accent">Read article →</span>
              </a>
            ))}
          </div>
        </div>
      ) : (
        <div data-animate class="mt-12 text-center">
          <p class="text-text-secondary">Check out our latest articles on the blog.</p>
          <a
            href="https://blog.devcult.io"
            class="mt-4 inline-block text-accent hover:text-accent-hover"
          >
            Visit blog.devcult.io →
          </a>
        </div>
      )
    }
  </div>
</section>
